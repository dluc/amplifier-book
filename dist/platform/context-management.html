<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Context Management</title>
    <link rel="stylesheet" href="/assets/site.css?v=31" />
  </head>
  <body>
    <div class="layout">
      <nav id="nav"></nav>
      <main>
        <h1>Context Management & Compaction</h1>

        <p>
          Context managers in Amplifier handle conversation history, keeping it within token limits while preserving
          important information. As of January 2026, context managers now inform the AI when compaction occurs.
        </p>

        <h2>Context Compaction Notices (New Feature)</h2>

        <p>
          When the context manager removes old messages to stay under token limits, it now injects a
          <strong>notice</strong> telling the AI what was removed and what was preserved.
        </p>

        <div class="callout ok">
          <strong>Why This Matters</strong>
          <div>
            <p>
              Previously, the AI would suddenly lose access to earlier context without knowing why. This could cause:
            </p>
            <ul>
              <li>Confusion about missing information</li>
              <li>Repeated questions</li>
              <li>Loss of conversation continuity</li>
            </ul>
            <p>
              Now the AI is explicitly told: "Earlier messages were compacted to manage token limits. Recent history
              and important tool results were preserved."
            </p>
          </div>
        </div>

        <h2>How Compaction Works</h2>

        <h3>Progressive Strategy (8 Levels)</h3>

        <p>The SimpleContextManager uses an 8-level progressive compaction strategy:</p>

        <ol>
          <li><strong>Level 1</strong>: Truncate old tool results (keep recent N)</li>
          <li><strong>Level 2</strong>: Remove old tool results completely</li>
          <li><strong>Level 3</strong>: Truncate user/assistant message pairs</li>
          <li><strong>Level 4</strong>: Remove older message pairs</li>
          <li><strong>Level 5-8</strong>: Increasingly aggressive removal</li>
        </ol>

        <p><strong>Always preserved</strong>:</p>
        <ul>
          <li>System messages (never removed)</li>
          <li>Most recent 30% of conversation</li>
          <li>Last 5 tool results</li>
        </ul>

        <h3>Compaction Notice Content</h3>

        <p>The notice tells the AI:</p>

        <ul>
          <li><strong>What was compacted</strong>: Token count, message count, tool results affected</li>
          <li><strong>What was preserved</strong>: System messages, recent history, important tools</li>
          <li><strong>What may be affected</strong>: Older messages, truncated results</li>
          <li><strong>Compaction level</strong>: How aggressively context was reduced (1-8)</li>
        </ul>

        <h3>Example Notice (Normal Verbosity)</h3>

        <pre><code>[Context Compaction Notice]

Conversation history compacted to manage token limits.

Removed: 12,500 tokens (15 messages, 8 tool results)
Preserved: System messages, recent 30% of conversation, last 5 tool results
Compaction level: 3

Earlier context may be unavailable. Recent history is intact.
</code></pre>

        <h2>Configuration</h2>

        <h3>Enabled by Default</h3>

        <p>Compaction notices are enabled by default in <code class="inline">context-simple</code>:</p>

        <pre><code class="language-yaml">session:
  context:
    module: context-simple
    config:
      max_tokens: 200000
      compact_threshold: 0.92
      # compaction_notice_enabled: true  # Default
</code></pre>

        <h3>Configuration Options</h3>

        <table class="data-table">
          <thead>
            <tr>
              <th>Option</th>
              <th>Default</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>compaction_notice_enabled</code></td>
              <td>true</td>
              <td>Enable/disable compaction notices</td>
            </tr>
            <tr>
              <td><code>compaction_notice_token_reserve</code></td>
              <td>800</td>
              <td>Tokens reserved for the notice</td>
            </tr>
            <tr>
              <td><code>compaction_notice_verbosity</code></td>
              <td>normal</td>
              <td>Detail level: minimal, normal, verbose</td>
            </tr>
            <tr>
              <td><code>compaction_notice_min_level</code></td>
              <td>1</td>
              <td>Only show notice if compaction level ≥ this</td>
            </tr>
          </tbody>
        </table>

        <h3>Verbosity Levels</h3>

        <p><strong>minimal</strong>: Brief notice (50-100 tokens)</p>
        <pre><code>[Compacted: 12,500 tokens removed, recent history preserved]</code></pre>

        <p><strong>normal</strong> (default): Balanced detail (200-400 tokens)</p>
        <pre><code>[Context Compaction: Level 3]
Removed 15 messages, preserved recent 30% and last 5 tool results.
Earlier context unavailable.</code></pre>

        <p><strong>verbose</strong>: Full details (600-800 tokens)</p>
        <pre><code>[Detailed Compaction Report]
Removed: 12,500 tokens across 15 messages
- 8 user/assistant pairs from early conversation
- 8 tool results (truncated or removed)
Preserved: All system messages, recent 30%, last 5 tools
Level: 3 (moderate compaction)
Impact: Earlier context gaps, recent history intact</code></pre>

        <h2>When Compaction Happens</h2>

        <p>Compaction triggers when context exceeds the threshold:</p>

        <pre><code class="language-python"># Default settings
max_tokens: 200,000        # Maximum context size
compact_threshold: 0.92    # Trigger at 92% full (184,000 tokens)
target_usage: 0.50         # Compact down to 50% (100,000 tokens)
</code></pre>

        <p><strong>Workflow</strong>:</p>
        <ol>
          <li>Context reaches 184,000 tokens (92% of 200,000)</li>
          <li>Compaction triggered</li>
          <li>Progressive removal until down to 100,000 tokens</li>
          <li>Notice injected explaining what happened</li>
          <li>AI continues with reduced context</li>
        </ol>

        <h2>Benefits</h2>

        <ul>
          <li><strong>AI awareness</strong> - Knows when context is limited</li>
          <li><strong>Better responses</strong> - Can ask user for missing info instead of guessing</li>
          <li><strong>Transparency</strong> - Users understand why AI "forgot" something</li>
          <li><strong>Debugging</strong> - Clear indication of context management in logs</li>
        </ul>

        <h2>Technical Details</h2>

        <h3>Notice Insertion</h3>

        <p>The notice is inserted at position 1 (after system message):</p>

        <pre><code class="language-python">[
  {"role": "system", "content": "Your system prompt..."},
  {"role": "system", "content": "[Compaction Notice]..."},  # ← Inserted here
  {"role": "user", "content": "Recent message 1"},
  {"role": "assistant", "content": "Recent response 1"},
  # ... rest of preserved conversation
]
</code></pre>

        <h3>Ephemeral Nature</h3>

        <p>The notice is <strong>ephemeral</strong>:</p>
        <ul>
          <li>Not persisted to session storage</li>
          <li>Only exists for that specific API call</li>
          <li>Regenerated on each compaction</li>
          <li>Counted within token limits</li>
        </ul>

        <h2>Monitoring Compaction</h2>

        <p>Check if compaction is happening in your sessions:</p>

        <pre><code class="language-bash"># View compaction events in logs
cat ~/.amplifier/projects/myproject/sessions/SESSION_ID/events.jsonl | \
  jq 'select(.event == "context:compaction") | {
    level: .data.level,
    removed_tokens: .data.removed_tokens,
    removed_messages: .data.removed_messages
  }'
</code></pre>

        <h2>Customization Examples</h2>

        <h3>Disable Notices</h3>

        <pre><code class="language-yaml">session:
  context:
    module: context-simple
    config:
      compaction_notice_enabled: false
</code></pre>

        <h3>Minimal Notices Only</h3>

        <pre><code class="language-yaml">session:
  context:
    module: context-simple
    config:
      compaction_notice_verbosity: minimal
      compaction_notice_min_level: 3  # Only for aggressive compaction
</code></pre>

        <h3>Verbose Debugging</h3>

        <pre><code class="language-yaml">session:
  context:
    module: context-simple
    config:
      compaction_notice_verbosity: verbose
      compaction_notice_min_level: 1  # Show all compaction
</code></pre>

        <h2>References</h2>

        <ul>
          <li>
            <a href="https://github.com/microsoft/amplifier-module-context-simple" target="_blank" rel="noreferrer">
              context-simple source code
            </a>
          </li>
          <li>Commit: 382352c - "feat: add context compaction notices to inform LLM"</li>
        </ul>

        <div class="callout">
          <strong>Bottom Line</strong>
          <div>
            <p>
              Context compaction notices improve AI behavior by providing transparency about token limit management.
              They're enabled by default and help the AI understand context gaps intelligently.
            </p>
          </div>
        </div>
      </main>
    </div>
    <script src="/assets/site.js?v=31"></script>
    <script>
      buildNav("nav");
    </script>
  </body>
</html>
